<!DOCTYPE html>
<title>Demo 3</title>
<script src="streaming-element.js"></script>
<script src="transform-stream-polyfill.js"></script>
<script src="streaming-element-backpressure.js"></script>
<script src="common.js"></script>
<link rel=stylesheet href="common.css">
<style>
#bugs {
    font-size: 16pt;
}

#bugs th {
    text-align: left;
}

#bugs tr:nth-child(even) {
    background-color: rgb(248, 248, 248);
}
</style>

<div><img src="https://i.imgur.com/iR98Hex.gif" alt="stream"></div>
<table id=button-table>
  <tr>
    <td><button id="atonce">fetch &rightarrow; innerHTML</button>
  <button id="streaming">fetch &rightarrow; stream</button>
  <button id="streaming_bp">streaming &rightarrow; stream + backpressure</button>
  <button id="reset">Reset</button>
    <td align=right id=next><a href=page4.html>Next >>></a>
</table>
<div id="target"></div>
<script>
let el = getElements(['target', 'atonce', 'streaming', 'streaming_bp', 'next',
                      'reset']);
el.next.style.visibility = 'visible';

function resetTarget() {
  el.target.innerHTML = '';
}

async function fetchThenInnerHTML() {
  const bulk = document.createElement('div');
  el.target.appendChild(bulk);
  const body = await fetch('bugs.html', {
    mode: 'same-origin',
    headers: {
      'Cache-Control': 'no-cache, no-store'
    }
  })
    .then(response => response.text());
  bulk.innerHTML = body;
}

async function fetchThenStream(elementName) {
  const streamingElement = document.createElement(elementName);
  el.target.appendChild(streamingElement);
  const result = await fetch('bugs.html', {
    mode: 'same-origin',
    headers: {
      'Cache-Control': 'no-cache, no-store'
    }
  });
  return result.body
    .pipeThrough(new TextDecoder())
    .pipeTo(streamingElement.writable);
}

el.atonce.onclick = async () => {
  resetTarget();
  // Insert the html asynchronously to stop the browser whining that the onclick
  // handler is taking too long.
  setTimeout(fetchThenInnerHTML, 0);
};

el.streaming.onclick = async () => {
  resetTarget();
  setTimeout(() => fetchThenStream('streaming-element'), 0);
};

el.streaming_bp.onclick = async () => {
  resetTarget();
  setTimeout(() => fetchThenStream('streaming-element-backpressure'), 0);
};

el.reset.onclick = resetTarget;

</script>
